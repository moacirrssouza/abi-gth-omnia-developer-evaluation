trigger:
- main
- develop
- feature/*
- release/*
- hotfix/*

pr:
- main
- develop
- feature/*
- release/*
- hotfix/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'

services:
  redis:
    image: redis:7-alpine
    ports:
      - 6379:6379
  mongo:
    image: mongo:7
    ports:
      - 27017:27017

steps:
- checkout: self

# -------------------------
# Setup .NET
# -------------------------
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '8.0.x'

# -------------------------
# Restore
# -------------------------
- script: |
    dotnet restore tests/Ambev.DeveloperEvaluation.Unit/Ambev.DeveloperEvaluation.Unit.csproj
    dotnet restore tests/Ambev.DeveloperEvaluation.Integration/Ambev.DeveloperEvaluation.Integration.csproj
    dotnet restore tests/Ambev.DeveloperEvaluation.Functional/Ambev.DeveloperEvaluation.Functional.csproj
  displayName: 'Restore projects'

# -------------------------
# Tests + Coverage
# -------------------------
- script: |
    dotnet test tests/Ambev.DeveloperEvaluation.Unit/Ambev.DeveloperEvaluation.Unit.csproj \
      --configuration $(buildConfiguration) \
      --collect:"XPlat Code Coverage" \
      --logger trx

    dotnet test tests/Ambev.DeveloperEvaluation.Integration/Ambev.DeveloperEvaluation.Integration.csproj \
      --configuration $(buildConfiguration) \
      --collect:"XPlat Code Coverage" \
      --logger trx

    dotnet test tests/Ambev.DeveloperEvaluation.Functional/Ambev.DeveloperEvaluation.Functional.csproj \
      --configuration $(buildConfiguration) \
      --collect:"XPlat Code Coverage" \
      --logger trx
  displayName: 'Run tests with coverage'

# -------------------------
# Install ReportGenerator
# -------------------------
- script: |
    dotnet tool install --global dotnet-reportgenerator-globaltool
    echo "##vso[task.prependpath]$HOME/.dotnet/tools"
  displayName: 'Install ReportGenerator'

# -------------------------
# Merge Coverage
# -------------------------
- script: |
    mkdir -p coverage
    reports=$(find . -name coverage.cobertura.xml | paste -sd ';')
    reportgenerator \
      -reports:"$reports" \
      -targetdir:"coverage" \
      -reporttypes:"Html;Cobertura"
  displayName: 'Generate merged coverage report'

# -------------------------
# Publish Test Results
# -------------------------
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'
    failTaskOnFailedTests: true

# -------------------------
# Publish Coverage
# -------------------------
- task: PublishCodeCoverageResults@2
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '**/coverage.cobertura.xml'
    reportDirectory: 'coverage'