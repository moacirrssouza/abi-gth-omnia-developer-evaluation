trigger:
- main
- develop
- feature/*
- release/*
- hotfix/*

pr:
- main
- develop
- feature/*
- release/*
- hotfix/*

pool:
  #vmImage: 'ubuntu-latest'
  name: Default  # seu pool self-hosted

variables:
  buildConfiguration: 'Release'
  solution: 'Ambev.DeveloperEvaluation.sln'

jobs:
- job: Build
  displayName: 'Build Solution'
  steps:
  - checkout: self
  
  - task: UseDotNet@2
    displayName: 'Use .NET 8.0'
    inputs:
      packageType: 'sdk'
      version: '8.0.x'

  - script: dotnet restore $(solution)
    displayName: 'Restore dependencies'

  - script: dotnet build $(solution) --configuration $(buildConfiguration) --no-restore
    displayName: 'Build solution'

- job: Test
  displayName: 'Run Tests'
  dependsOn: Build
  
  services:
    redis:
      image: redis:7-alpine
      ports:
        - 6379:6379
    mongo:
      image: mongo:7
      ports:
        - 27017:27017
      env:
        MONGO_INITDB_DATABASE: testdb
  
  steps:
  - checkout: self
  
  - task: UseDotNet@2
    displayName: 'Use .NET 8.0'
    inputs:
      packageType: 'sdk'
      version: '8.0.x'

  - script: dotnet restore $(solution)
    displayName: 'Restore dependencies'

  - script: |
      dotnet test tests/Ambev.DeveloperEvaluation.Unit/Ambev.DeveloperEvaluation.Unit.csproj \
        --configuration $(buildConfiguration) \
        --collect:"XPlat Code Coverage" \
        --logger trx \
        --results-directory $(Agent.TempDirectory)/TestResults
    displayName: 'Run Unit Tests'

  - script: |
      dotnet test tests/Ambev.DeveloperEvaluation.Integration/Ambev.DeveloperEvaluation.Integration.csproj \
        --configuration $(buildConfiguration) \
        --collect:"XPlat Code Coverage" \
        --logger trx \
        --results-directory $(Agent.TempDirectory)/TestResults
    displayName: 'Run Integration Tests'
    env:
      REDIS_CONNECTION: localhost:6379
      MONGO_CONNECTION: mongodb://localhost:27017

  - script: |
      dotnet test tests/Ambev.DeveloperEvaluation.Functional/Ambev.DeveloperEvaluation.Functional.csproj \
        --configuration $(buildConfiguration) \
        --collect:"XPlat Code Coverage" \
        --logger trx \
        --results-directory $(Agent.TempDirectory)/TestResults
    displayName: 'Run Functional Tests'
    env:
      REDIS_CONNECTION: localhost:6379
      MONGO_CONNECTION: mongodb://localhost:27017

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: '$(Agent.TempDirectory)/TestResults/**/*.trx'
      failTaskOnFailedTests: true

  - script: |
      dotnet tool install --global dotnet-reportgenerator-globaltool
      export PATH="$PATH:$HOME/.dotnet/tools"
    displayName: 'Install ReportGenerator'

  - script: |
      reportgenerator \
        -reports:$(Agent.TempDirectory)/TestResults/**/coverage.cobertura.xml \
        -targetdir:$(Build.SourcesDirectory)/coverage \
        -reporttypes:"HtmlInline_AzurePipelines;Cobertura"
    displayName: 'Generate Code Coverage Report'

  - task: PublishCodeCoverageResults@2
    displayName: 'Publish Code Coverage Results'
    inputs:
      summaryFileLocation: $(Build.SourcesDirectory)/coverage/Cobertura.xml